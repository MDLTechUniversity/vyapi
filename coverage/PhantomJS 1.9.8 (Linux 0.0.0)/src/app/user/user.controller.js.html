<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/app/user/user.controller.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../index.html">all files</a> / <a href="index.html">src/app/user/</a> user.controller.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">9.86% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>7/71</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">12.5% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>2/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">8.33% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>1/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">1.85% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>1/54</span>
      </div>
      <div class='fl pad1y'>
        <span class="strong">4 statements, 1 function, 2 branches</span>
        <span class="quiet">Ignored</span>  &nbsp;&nbsp;&nbsp;&nbsp;
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">export class UserController {
<span class="fstat-no" title="function not covered" >  constructor($firebaseArray, $firebaseAuth, $log, $location, $window, $stateParams,$cookies) <span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >{</span></span></span></span>
<span class="cstat-no" title="statement not covered" >    'ngInject';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var appURL = "https://vyapi.firebaseio.com/";</span>
<span class="cstat-no" title="statement not covered" >    var onlineUsersRef = new Firebase(appURL + "onlineUsers/");</span>
<span class="cstat-no" title="statement not covered" >    this.messageContributions = [];</span>
<span class="cstat-no" title="statement not covered" >    t</span>his.onlineUsers = {}; //angular is watching this array
    this.cookies = $cookies;
<span class="cstat-no" title="statement not covered" >    $</span>firebaseArray(onlineUsersRef); //no idea what this line does, but removing this cripples whole application
&nbsp;
    this.goOnline = <span class="fstat-no" title="function not covered" >function() <span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >{</span></span></span></span></span></span></span></span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      v</span>ar uid;
&nbsp;
      //find user ID of self
      this.fa = $firebaseAuth;
<span class="cstat-no" title="statement not covered" >      this.ref = new Firebase(appURL);</span>
<span class="cstat-no" title="statement not covered" >      this.authObj = this.fa(this.ref);</span>
<span class="cstat-no" title="statement not covered" >      var authData = this.authObj.$getAuth();</span>
<span class="cstat-no" title="statement not covered" >      i</span>f (authData) {
<span class="cstat-no" title="statement not covered" >        $log.log("Logged in as:", authData.uid);</span>
<span class="cstat-no" title="statement not covered" >        uid = authData.uid;</span>
      } else {
<span class="cstat-no" title="statement not covered" >        var path = $location.path();</span>
<span class="cstat-no" title="statement not covered" >        this.cookies.put('path',path);</span>
<span class="cstat-no" title="statement not covered" >        alert("Not Logged in. Please login\n Redirecting to login page");</span>
<span class="cstat-no" title="statement not covered" >        $window.location.href = "http://" + $window.location.host + "#/";</span>
<span class="cstat-no" title="statement not covered" >        $log.error("Not Logged in. Please login");</span>
<span class="cstat-no" title="statement not covered" >        return;</span>
      }
&nbsp;
      //get roomId from URL
      var roomId = $stateParams.roomKey;
&nbsp;
      //check self connection state
      var connectedRef = new Firebase(appURL + ".info/connected");
<span class="cstat-no" title="statement not covered" >      c</span>onnectedRef.on("value", <span class="fstat-no" title="function not covered" >(snap) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >        i</span>f (snap.val() === true) <span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >{</span></span>
<span class="cstat-no" title="statement not covered" >          $</span>log.log("connected");
          //register self as online
&nbsp;
          onlineUsersRef.child(roomId + "/" + uid).set("0");
&nbsp;
          //verify the room id existance
          (new Firebase(appURL + "rooms/")).orderByKey().equalTo(roomId).on("value", <span class="fstat-no" title="function not covered" >(snap)=&gt;{</span>
<span class="cstat-no" title="statement not covered" >            i</span>f(snap.exists() == false) {
<span class="cstat-no" title="statement not covered" >              $log.error("Room: " + roomId + " does not exist");</span>
<span class="cstat-no" title="statement not covered" >              alert("Room: " + roomId + " does not exist.\nRedirecting to dashboard");</span>
<span class="cstat-no" title="statement not covered" >              $window.location.href = "http://" + $window.location.host + "#/dashboard";</span>
<span class="cstat-no" title="statement not covered" >              return;</span>
            } else <span class="cstat-no" title="statement not covered" >{</span>
              //register self as online. add self to members of the room
<span class="cstat-no" title="statement not covered" >              (</span>new Firebase(appURL + "rooms/" + roomId + "/members/" + uid)).set("0"); //0 is insignificant
&nbsp;
              //setup offline mechanism when going offline
              onlineUsersRef.child(roomId + "/" + uid).onDisconnect().remove();
            }
          });
        } else {
<span class="cstat-no" title="statement not covered" >          $log.warn("not connected");</span>
        }
      });
&nbsp;
      //user came online
      onlineUsersRef.child(roomId).on("child_added", <span class="fstat-no" title="function not covered" >(userId) =&gt; <span class="cstat-no" title="statement not covered" >{</span></span>
<span class="cstat-no" title="statement not covered" >        $</span>log.log("User: " + userId.key() + " came online");
&nbsp;
        //fetch details of the user that just came online
        (new Firebase(encodeURI(appURL + "users/" + userId.key() + "/google/cachedUserProfile/given_name/"))).once("value", <span class="fstat-no" title="function not covered" >(value) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >          var userName = value.val();</span>
<span class="cstat-no" title="statement not covered" >          (new Firebase(encodeURI(appURL + "users/" + userId.key() + "/google/profileImageURL/"))).once("value", <span class="fstat-no" title="function not covered" >(value) =&gt; {</span></span>
<span class="cstat-no" title="statement not covered" >            var profileImageURL = value.val();</span>
<span class="cstat-no" title="statement not covered" >            this.onlineUsers[userId.key()] = {name: userName, photo : profileImageURL};</span>
<span class="cstat-no" title="statement not covered" >            f</span>or(var u in this.onlineUsers)
<span class="cstat-no" title="statement not covered" >              $</span>log.log(u);
          });
        });
      });
&nbsp;
      //user went offline
      onlineUsersRef.child(roomId).on("child_removed", <span class="fstat-no" title="function not covered" >(userId)=&gt; {</span>
<span class="cstat-no" title="statement not covered" >        $log.log("User: " + userId.key() + " went offline");</span>
<span class="cstat-no" title="statement not covered" >        delete this.onlineUsers[userId.key()];</span>
      });
&nbsp;
      //+1 to badge when user adds new message
      (new Firebase(appURL + "messages/" + $stateParams.roomKey)).on("child_added", <span class="fstat-no" title="function not covered" >(messageObj) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >        i</span>f(messageObj.val().from == "anonymous") //let user remain anonymous by not showing his contribution
<span class="cstat-no" title="statement not covered" >          return;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        i</span>f(this.messageContributions[messageObj.val().uid] == undefined)
<span class="cstat-no" title="statement not covered" >          this.messageContributions[messageObj.val().uid] = 0;</span>
<span class="cstat-no" title="statement not covered" >        this.messageContributions[messageObj.val().uid] += 1;</span>
      });
&nbsp;
      //-1 to badge when user removes message
      (new Firebase(appURL + "messages/" + $stateParams.roomKey)).on("child_removed", <span class="fstat-no" title="function not covered" >(messageObj) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >        i</span>f(messageObj.val().from == "anonymous") // post deleted was anonymous, so no need to decrement contribution
<span class="cstat-no" title="statement not covered" >          return;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        this.messageContributions[messageObj.val().uid] -= 1;</span>
      });
&nbsp;
      //function used in ng-repeat to get contributions info
      this.getMessageContributions = <span class="fstat-no" title="function not covered" >function(uid) {</span>
<span class="cstat-no" title="statement not covered" >        i</span>f(this.messageContributions[uid] == undefined) { //no contributions done by this user
<span class="cstat-no" title="statement not covered" >          return 0;</span>
        }
<span class="cstat-no" title="statement not covered" >        return this.messageContributions[uid];</span>
      }
&nbsp;
    } //end of this.goOnline
&nbsp;
    this.goOnline();
  } //end of constructor
} //end of UserController
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Feb 27 2016 13:38:30 GMT+0530 (IST)
</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
