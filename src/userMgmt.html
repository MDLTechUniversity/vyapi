<!DOCTYPE html>
<html ng-App>
  <head>
    <style>
      img {
        height: 2em;
        margin: 0.2em;
      }
​
      li, ul {
        display: inline;
      }

      #showAllUsers {
        display: none;
      }
    </style>
    <script src="https://cdn.firebase.com/js/client/2.2.1/firebase.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    <script>


      (function(){
        angular.module("presenceApp", []);
        angular.module("presenceApp").controller("presenceCtrl", function() {

          this.onlineUsers = [];

          var appURL = "https://incandescent-inferno-4532.firebaseio.com/";
          var onlineUsersRef = new Firebase(appURL + "onlineUsers");

          this.goOnline = function() {
            //get uid from cookie or from wherever the authentication teams decides
            var uid = Math.floor(Math.random() * 999999999) + 1;
            //hard coding right now
            uid = "google:110298804653203543045"
            console.log("My uid is: " + uid);

            //check self connection state
            var connectedRef = new Firebase(appURL + ".info/connected");
            connectedRef.on("value", function(snap) {
              if (snap.val() === true) {
                console.log("connected :)");
​
                //register self as online
                onlineUsersRef.child(uid.toString()).set("1");
​
                //setup offline mechanism when going offline
                onlineUsersRef.child(uid.toString()).onDisconnect().remove();
              } else {
                console.log("not connected :(");
              }
            });

            //user came online
            onlineUsersRef.on('child_added', function(userId) {
              console.log("User: " + userId.key() + " came online");

              var userName, profileImageURL;
              (new Firebase(encodeURI(appURL + "userAuthInfo/" + userId + "/google/cachedUserProfile/given_name/"))).once("value", function(value) {
                userName = value.val();
              });

              (new Firebase(encodeURI(appURL + "userAuthInfo/" + userId + "/google/profileImageURL/"))).once("value", function(value) {
                profileImageURL = value.val();
              });

              this.onlineUsers.push({"name" : userName});
            });
​
            //user went offline
            onlineUsersRef.on('child_removed', function(userId) {
              console.log("User: " + userId.key() + " went offline");
              pop(userId);
            });
          }
        });
      })();

    </script>
  </head>
  <body ng-app="presenceApp" >
      <ul ng-controller="presenceCtrl" >
        <li ng-repeat = "users in onlineUsers.list">
          <img title={{users.name}} alt={{users.name}}></li>
      </ul>
      <a href="#" id="showAllUsers" >...</a>
  </body>
</html>
